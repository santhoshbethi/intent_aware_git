#!/usr/bin/env python
"""
Commit-msg hook for validating commits against Jira stories.
This hook runs after the commit message is written and validates it against Jira.
"""

import sys
import os
import subprocess

# Find the git repository root and add to path
try:
    result = subprocess.run(
        ['git', 'rev-parse', '--show-toplevel'],
        capture_output=True,
        text=True,
        check=True
    )
    repo_root = result.stdout.strip()
    sys.path.insert(0, repo_root)
except:
    print("[ERROR] Could not determine git repository root")
    sys.exit(1)

from cli.jira_client import JiraClient
from cli.ai_validator import AIValidator
from cli.utils import get_git_diff


def get_commit_message():
    """Get the commit message from the git commit."""
    commit_msg_file = sys.argv[1] if len(sys.argv) > 1 else '.git/COMMIT_EDITMSG'
    
    try:
        with open(commit_msg_file, 'r') as f:
            return f.read().strip()
    except:
        return None


def print_error(message):
    """Print error message in red."""
    print(f"\n\033[91m[ERROR]\033[0m {message}\n")


def print_warning(message):
    """Print warning message in yellow."""
    print(f"\n\033[93m[WARNING]\033[0m {message}\n")


def print_success(message):
    """Print success message in green."""
    print(f"\n\033[92m[SUCCESS]\033[0m {message}\n")


def print_info(message):
    """Print info message."""
    print(f"\n\033[94m[INFO]\033[0m {message}\n")


def main():
    """Main hook logic."""
    
    commit_message = get_commit_message()
    if not commit_message:
        print_error("Could not read commit message")
        return 1
    
    # Check if validation should be skipped
    skip_validation = os.environ.get('SKIP_INTENT_VALIDATION', '').lower() in ['1', 'true', 'yes']
    skip_markers = ['[skip-validation]', '[no-validation]', '[skip ci]']
    
    if skip_validation or any(marker in commit_message.lower() for marker in skip_markers):
        print_info("Intent validation skipped")
        return 0
    
    print_info("Validating commit against Jira story...")
    
    # Step 1: Check for Jira ID (optional)
    try:
        jira_client = JiraClient()
        is_valid, jira_id, error = jira_client.validate_commit_message_format(commit_message)
        
        if not is_valid:
            # No Jira ID found - skip validation
            print_info("No Jira ID found in commit message - skipping validation")
            return 0
        
        print_success(f"Found Jira ID: {jira_id}")
    
    except ValueError as e:
        print_warning(f"Jira not configured: {e}")
        print("Set JIRA_URL, JIRA_EMAIL, JIRA_API_TOKEN in .env to enable Jira validation")
        print("\nProceeding without Jira validation...")
        return 0
    
    # Step 2: Fetch Jira story
    try:
        print_info(f"Fetching Jira story {jira_id}...")
        issue = jira_client.get_issue(jira_id)
        print_success(f"Story: {issue['summary']}")
        print(f"Type: {issue['issue_type']} | Status: {issue['status']}")
    
    except ValueError as e:
        print_error(str(e))
        print("\nTo skip validation: SKIP_INTENT_VALIDATION=1 git commit ...")
        return 1
    
    # Step 3: Get git diff
    diff = get_git_diff()
    if not diff:
        print_warning("No staged changes found")
        return 0
    
    # Step 4: AI Validation (optional, can be disabled)
    enable_ai = os.environ.get('ENABLE_AI_VALIDATION', 'true').lower() in ['1', 'true', 'yes']
    
    if enable_ai:
        try:
            print_info("Running AI validation against Jira story...")
            
            validator = AIValidator()
            intent_text = jira_client.format_issue_for_validation(issue)
            
            validation_result = validator.validate_intent(intent_text, diff)
            
            if 'error' not in validation_result:
                score = validation_result.get('score', 0)
                confidence = validation_result.get('confidence', 0)
                key_func_present = validation_result.get('key_functionality_present', False)
                
                print(f"\nAlignment Score: {score}/10 (Confidence: {confidence}%)")
                
                if not key_func_present:
                    print_error("KEY FUNCTIONALITY from Jira story is MISSING in code changes!")
                
                if score < 3:
                    print_error("CRITICAL MISMATCH - Code does NOT implement Jira story!")
                    
                    if validation_result.get('discrepancies'):
                        print("\nIssues found:")
                        for disc in validation_result['discrepancies']:
                            print(f"  - {disc}")
                    
                    print("\nOptions:")
                    print("  1. Fix the code to match the story")
                    print("  2. Update the Jira story to match what you're doing")
                    print("  3. Skip: SKIP_INTENT_VALIDATION=1 git commit ...")
                    
                    return 1
                
                elif score < 5:
                    print_warning(f"LOW alignment score ({score}/10)")
                    
                    if validation_result.get('discrepancies'):
                        print("\nDiscrepancies:")
                        for disc in validation_result['discrepancies']:
                            print(f"  - {disc}")
                    
                    # Allow but warn
                    print("\nProceeding with warning...")
                
                else:
                    print_success(f"Good alignment ({score}/10)")
        
        except ValueError as e:
            print_warning(f"AI validation disabled: {e}")
            print("Set OPENAI_API_KEY in .env to enable AI validation")
        
        except Exception as e:
            print_warning(f"AI validation error: {e}")
            print("Proceeding without AI validation...")
    
    print_success("Commit validation passed!")
    return 0


if __name__ == '__main__':
    sys.exit(main())
