name: PR Intent Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate-intent:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -e .

      - name: Validate PR commits against Jira stories
        env:
          JIRA_URL: ${{ secrets.JIRA_URL }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_BASE_REF: ${{ github.base_ref }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          chmod +x scripts/validate_pr.py
          python3 scripts/validate_pr.py

      - name: Comment on PR
        uses: actions/github-script@v6
        if: always()
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('pr_comment.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
                  
                  if (result.suggestions && result.suggestions.length > 0) {
                    comment += '**Suggestions:**\\n';
                    result.suggestions.forEach(s => comment += `- ${s}\\n`);
                    comment += '\\n';
                  }
                  
                  comment += '---\\n\\n';
                }
                
                // Summary
                const avgScore = results.reduce((sum, r) => sum + (r.score || 0), 0) / results.length;
                const critical = results.filter(r => (r.score || 10) < 3).length;
                const low = results.filter(r => (r.score || 10) >= 3 && (r.score || 10) < 5).length;
                const good = results.filter(r => (r.score || 10) >= 7).length;
                
                comment += '### Summary\\n\\n';
                comment += `- **Average Score:** ${avgScore.toFixed(1)}/10\\n`;
                comment += `- **Stories Validated:** ${results.length}\\n`;
                comment += `- **Critical Issues:** ${critical}\\n`;
                comment += `- **Low Alignment:** ${low}\\n`;
                comment += `- **Good Alignment:** ${good}\\n`;
                
                if (critical > 0) {
                  comment += '\\n**Action Required:** Critical alignment issues found. Review before merging.\\n';
                }
              }
            } catch (e) {
              comment += ` Could not read validation results: ${e.message}\\n`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

